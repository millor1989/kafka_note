### 分布式（Distribution）

#### 1、消费者偏移追踪

Kafka消费者追踪它消费过的每个分区的最大偏移，并且具有提交偏移的能力（commit offset），以便在重启的时候它可以从这些偏移恢复。Kafka提供了将某个消费者群组的所有的偏移保存在一个指定的叫作组协调器（group coordinator）的代理（为这个群组）的选项。即，这个消费者群组中的任何消费者实例应该向组协调器提交和获取它的偏移。消费者组会被基于它们的组名分配到协调器。消费者可以通过向任意Kafka代理发起`FindCoordinatorRequest`请求查询它的协调器，并且读取包含了协调器详情的`FindCoordinatorResponse`。消费者随后可以向协调器提交或者获取偏移。如果协调器移动，消费者就需要重新发现协调器。消费者实例可以自动地或者手动的进行偏移提交。

当组协调器收到`OffsetCommitRequest`，它把这个请求追加到一个叫作*\_\_consumer\_offsets*的专用的压缩的Kafka主题。当这个偏移主题的所有备份都收到这些偏移后，代理发送一个成功的偏移提交响应。如果，在一个可配置的超时时间内，偏移备份失败，那么偏移提交失败，消费者可以在回退后重试提交。代理会周期性的压缩这个偏移主题，因为它只需要维护每个分区罪行的偏移提交。协调器也会缓存这些偏移到一个内存表中，以快速响应偏移获取。

当协调器收到偏移获取请求，它简单地从偏移缓存返回最后提交的偏移向量。如果协调器刚刚启动，或者刚称为一个新的消费者组的协调器，它可能需要把偏移主题分区加载到缓存。这时，偏移获取会失败，并得到一个`CoordinatorLoadInProgressException`，消费者可以在回退之后重试`OffsetFetchRequest`。

#### 2、ZooKeeper目录

后面会描述用于消费者和代理之间协调的ZooKeeper架构和算法。

##### 2.1、符号

路径中一个元素用`[xyz]`表示，意味着xyz不是特指，而是xyz的任意可能值指代的ZooKeeper的znode。比如`/topic/[topic]`是名为`/topics`的目录包含的所有子目录。用比如`[0...5]`的形式指定的数值范围表示子目录0，1，2，3，4。剪头`->`用于表示znode的内容。比如`/hello -> world`表示一个znode`/hello`包含了值`world`。

##### 2.2、代理节点注册表

```json
  /brokers/ids/[0...N] --> {"jmx_port":...,"timestamp":...,"endpoints":[...],"host":...,"version":...,"port":...} (ephemeral node)
```

这是一个所有代理节点的列表，每个都提供了一个唯一地逻辑代理id，对消费者是唯一的（必须通过配置指定）。启动时，代理节点通过用逻辑代理id在`/brokers/ids`下创建一个znode来注册自己。逻辑代理id的目的是允许代理在不影响消费者的情况下移动到一个不同的物理机。尝试注册一个已经存在的代理id（比如，因为两台服务器是使用相同的代理id配置的）会报错。

因为代理在ZooKeeper中注册自己使用的是暂时znodes，这个注册是动态的，并且如果代理关闭或者故障就会消失（这样，可以通知消费者它不再可用）。

##### 2.3、代理主题注册表

```json
  /brokers/topics/[topic]/partitions/[0...N]/state --> {"controller_epoch":...,"leader":...,"version":...,"leader_epoch":...,"isr":[...]} (ephemeral node)
```

每个代理在它维护的主题下注册自己，并为这个主题保存分区的数量。

##### 2.4、集群Id

集群id是分配给Kafka集群的唯一的不可变的身份。集群id最多22个字符，允许使用正则表达式[a-zA-Z0-9_\\-]+定义的字符，这与没有填充的URL-safe Base64变种使用的字符对应。从概念上讲，它是当集群第一次启动时自动生成的。

实现上，版本0.10.1或者以后的版本代理第一次成功启动时生成集群id。代理会在启动期间尝试从`/cluster/id`znode获取集群id。如果znode不存在，代理生成一个新的集群id，并创建具有这个集群id的znode。

##### 2.5、代理节点注册

代理节点基本上是独立的，它们只发布它们有的信息。当新的代理加入，它会在代理节点注册表目录下注册自己并写入它的主机名和端口。代理也注册既存主题的列表和代理主题注册表中它们的逻辑分区。当主题在代理商被创建时，新的主题会被动态的注册。